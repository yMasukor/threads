<!doctype html>
<html>
	<head>
	<script src="lib/jquery-2.1.3.min.js"></script>
	<script src="lib/tween.min.js"></script>
    <script src="lib/tsw.js"></script>
	<script src="lib/two.js"></script>



	<script src="states/themes.js"></script>
	<script src="states/state-one.js"></script>
	<script src="states/state-two.js"></script>

	<script src="https://cdn.socket.io/socket.io-1.3.3.js"></script>

	<script></script>
	
	


	</head>
	<body>

	<script>

		var TWO_PI = Math.PI * 2;

        var width = $(window).width(), height = $(window).height();
        var center = {x: width/2, y:height/2}

        


        var sixteenthNoteDuration = 140;

        var duration = sixteenthNoteDuration*16;
        var animations = {}
        var Easing = TWEEN.Easing;

        var socket = io();



        
		var beatCount = 0;
		var barCount = 0;
        





		var states = [stateTwo]
		var state = states[0];



		//Create Two instance
		var two = new Two({
			fullscreen: true,
			type: Two.Types.canvas,
		}).appendTo(document.body);

		two.renderer.domElement.style.background = state.theme.back;


		//Create layers
		var backgroundLayer = two.makeGroup();
		var threadLayer = two.makeGroup();


		var samplesLoaded = false;

		var threadStatus = 'empty';



        

		var activeBackingTrack = [
			
			//01
			['timer', 'strike'],
			//02
			[],
			//03
			['moon', 'strike'],
			//04
			[],
			//05
			['piston2', 'strike'],
			//06
			[],
			//07
			['moon', 'strike'],
			//08
			['timer'],
			//09
			['strike'],
			//10
			[],
			//11
			['moon', 'timer'],
			//12
			[],
			//13
			['piston2'],
			//14
			[],
			//15
			['moon'],
			//16
			['strike'],


			
			//01
			['timer', 'strike'],
			//02
			[],
			//03
			['moon', 'strike'],
			//04
			[],
			//05
			['piston2', 'strike'],
			//06
			[],
			//07
			[],
			//08
			['timer'],
			//09
			['strike'],
			//10
			[],
			//11
			['moon','timer'],
			//12
			[],
			//13
			['piston2'],
			//14
			['timer'],
			//15
			['moon'],
			//16
			['strike'],

			//01
			['timer', 'strike'],
			//02
			[],
			//03
			['moon', 'strike'],
			//04
			[],
			//05
			['piston2', 'strike'],
			//06
			[],
			//07
			['moon', 'strike'],
			//08
			['timer'],
			//09
			['strike'],
			//10
			[],
			//11
			['moon', 'timer'],
			//12
			[],
			//13
			['piston2'],
			//14
			[],
			//15
			['moon'],
			//16
			['strike'],


			
			//01
			['timer', 'strike'],
			//02
			[],
			//03
			['moon', 'strike'],
			//04
			[],
			//05
			['piston2', 'strike'],
			//06
			[],
			//07
			[],
			//08
			['timer'],
			//09
			['strike'],
			//10
			[],
			//11
			['moon','timer'],
			//12
			[],
			//13
			['piston2'],
			//14
			['timer'],
			//15
			['moon'],
			//16
			['strike'],

		]







		var backingTrack = [
			
			//01
			[],
			//02
			[],
			//03
			['moon'],
			//04
			[],
			//05
			['piston2'],
			//06
			[],
			//07
			['moon'],
			//08
			[],
			//09
			[],
			//10
			[],
			//11
			['moon'],
			//12
			[],
			//13
			['piston2'],
			//14
			[],
			//15
			['moon'],
			//16
			[],


			
			//01
			[],
			//02
			[],
			//03
			['moon'],
			//04
			[],
			//05
			['piston2'],
			//06
			[],
			//07
			[],
			//08
			[],
			//09
			[],
			//10
			[],
			//11
			['moon'],
			//12
			[],
			//13
			['piston2'],
			//14
			[],
			//15
			['moon'],
			//16
			[],

			//01
			[],
			//02
			[],
			//03
			['moon'],
			//04
			[],
			//05
			['piston2'],
			//06
			[],
			//07
			['moon'],
			//08
			[],
			//09
			[],
			//10
			[],
			//11
			['moon'],
			//12
			[],
			//13
			['piston2'],
			//14
			[],
			//15
			['moon'],
			//16
			[],


			
			//01
			[],
			//02
			[],
			//03
			['moon'],
			//04
			[],
			//05
			['piston2'],
			//06
			[],
			//07
			[],
			//08
			[],
			//09
			[],
			//10
			[],
			//11
			['moon'],
			//12
			[],
			//13
			['piston2'],
			//14
			[],
			//15
			['moon'],
			//16
			[]

		]







		var idleBackingTrack = [
			
			//01
			[],
			//02
			[],
			//03
			['strike'],
			//04
			[],
			//05
			[],
			//06
			[],
			//07
			['moon'],
			//08
			[],
			//09
			['strike'],
			//10
			[],
			//11
			['strike'],
			//12
			[],
			//13
			[],
			//14
			['strike'],
			//15
			[],
			//16
			[],


			
			//01
			['strike'],
			//02
			[],
			//03
			['strike'],
			//04
			[],
			//05
			[],
			//06
			[],
			//07
			['moon'],
			//08
			[],
			//09
			['strike'],
			//10
			[],
			//11
			['strike'],
			//12
			[],
			//13
			[],
			//14
			['strike'],
			//15
			[],
			//16
			[],

			//01
			[],
			//02
			[],
			//03
			['strike'],
			//04
			[],
			//05
			[],
			//06
			[],
			//07
			['moon'],
			//08
			[],
			//09
			['strike'],
			//10
			[],
			//11
			['strike'],
			//12
			[],
			//13
			[],
			//14
			['strike'],
			//15
			[],
			//16
			[],


			
			//01
			['strike'],
			//02
			[],
			//03
			['strike'],
			//04
			[],
			//05
			[],
			//06
			[],
			//07
			['moon'],
			//08
			[],
			//09
			['strike'],
			//10
			[],
			//11
			['strike'],
			//12
			[],
			//13
			[],
			//14
			['strike'],
			//15
			[],
			//16
			[],

		]
		





		var players = {};
		var threads = [];

        
		


		$(document).ready(function(){

			//bind sockets

			//connect to the server
			socket.emit('connectViewer');

			socket.on('connected', function(existingPlayers){
				existingPlayers.forEach(function(playerId){
					addPlayer(playerId);
				});

				console.log('viewer connected, existing players', players, existingPlayers);
			});

			//add player when they connect
			socket.on('addPlayer', function(playerId){
				addPlayer(playerId);
			});

			//recieve player input
			socket.on('playerUpdate', function(input){

				// console.log('update', input)

				if(input.type == 'start'){
					players[input.id].dragStart(input);
				}else if(input.type == 'drag'){
					players[input.id].drag(input);
				}else if(input.type == 'end'){
					players[input.id].dragEnd(input);
				}
			});



			//Listen for tick
			socket.on('tick', function(beatCount){
				if(beatCount == 0){
					console.log('new bar', animations);

					setState(states[Math.floor(Math.random()*states.length)])
				}


				if(samplesLoaded){
					if(threadStatus == 'drawing'){
						// console.log('beatCount', beatCount)
						backingTrack[beatCount].forEach(function(sample){
							// console.log(sample)
							namedSamples[sample].play();


						});

					}else if(threadStatus == 'playing'){
						activeBackingTrack[beatCount].forEach(function(sample){
							// console.log(sample)
							namedSamples[sample].play();


						});
					}else{
						idleBackingTrack[beatCount].forEach(function(sample){
							// console.log(sample)
							namedSamples[sample].play();


						});
					}
				}

				threads.forEach(function(thread){
					thread.triggerCuePoints(beatCount)
				});
			});










			var sliceWidth = width * 2.5 / bufferLength;
			var x = 0;
			var points = [new Two.Anchor(width, 0), new Two.Anchor(0, 0)];

			for(var i=0; i<bufferLength; i++){
				

		        var v = dataArray[i] * 2;
		        var y = v //* height/2;

		        var point = new Two.Anchor(x, y);
		        // if(i === 0) {
		        //   canvasCtx.moveTo(x, y);
		        // } else {
		        //   canvasCtx.lineTo(x, y);
		        // }

		        points.push(point);
		        x += sliceWidth;


			}


			var shape = two.makeCurve(points, false);
            shape.noStroke();
            shape.fill = state.theme.highlight;







			two.bind('update', function(frameCount) {
				//Update animateables
                TWEEN.update();
	           
                threads.forEach(function(thread){
                	thread.update();
                });

                analyser.getByteFrequencyData(dataArray);
                // console.log(dataArray);
		


                for(var i=0; i<bufferLength; i++){

                	var point = shape.vertices[i+2];

                	var v = dataArray[i] * 2;
		        	var y = v //* height/2;

		       		point.y = y;

		       		// console.log(y)

                };


	      	}).play();








			// DEBUG PLAYER
			addPlayer('foobar');
			$(window).bind('mousedown', dragStart);
            $(window).bind('mousemove', drag);
            $(window).bind('mouseup', dragEnd);
            




		});


		function addPlayer(playerId){
			var player = new Player(playerId);
			players[playerId] = player;

			console.log('players', players)
		}






		function setState(newState){

			state = newState;
			//update background color
			animations['horizontalWipe'].start(state.theme.back);


			//update 
		}




	 //    function makeNgon(w, h, s){
	 //    	var shape = this.makePolygon(
		// 		_.map(_.range(s), function(i) {
		// 			var percent = i / s;
		// 			var theta = TWO_PI * percent - Math.PI / 2;
		// 			var x = w * Math.cos(theta);
		// 			var y = h * Math.sin(theta);
		// 			return new Two.Anchor(x, y);
		// 		})
		// 	);

		// 	return shape
	 //    }



		var isDragging

        var dragStart = function(e){
            // e.preventDefault();
            isDragging = true;

            var input = {
                type:'start',
                x:e.clientX,
                y:e.clientY,
            }

            players['foobar'].dragStart(input);

            
        }

        var drag = function(e){
            // e.preventDefault();
            if(isDragging){
                var input = {
                    type:'drag',
                    x:e.clientX,
                    y:e.clientY,
                }

                players['foobar'].drag(input);
            }

            return false;
        }

        var dragEnd = function(e){
            // e.preventDefault();
            isDragging = false;

            var input = {
                type:'end',
                x:e.clientX,
                y:e.clientY,
            }

            players['foobar'].dragEnd(input);

            return false;
        }


	</script>

	<script src="Player.js"></script>
	<script src="CuePoint.js"></script>
    <script src="threads-alt.js"></script>
    <script src="metronome.js"></script>
    <script src="animations.js"></script>
    <script src="audio.js"></script>
	</body>
</html>