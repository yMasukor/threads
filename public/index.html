<!doctype html>
<html>
	<head>
	<script src="lib/jquery-2.1.3.min.js"></script>
	<script src="lib/tween.min.js"></script>
    <script src="lib/tsw.js"></script>
	<script src="lib/two.js"></script>

	<script src="https://cdn.socket.io/socket.io-1.3.3.js"></script>

	<script></script>
	
	


	</head>
	<body>

	<script>

		var TWO_PI = Math.PI * 2;

        var width = $(window).width(), height = $(window).height();
        var center = {x: width/2, y:height/2}

        var two = new Two({
			fullscreen: true,
			type: Two.Types.canvas,
		}).appendTo(document.body);


        var sixteenthNoteDuration = 125;

        var duration = sixteenthNoteDuration*16;
        var animations = {}
        var Easing = TWEEN.Easing;

        var socket = io();



        
		var beatCount = 0;
		var barCount = 0;
        

        // var colors=[
        //     //Cool Grey
        //     '#263238', 
        //     '#ECEFF1', 
        //     '#607D8B', 
        //     //Reds
        //     '#F44336', 
        //     '#B71C1C', 
        //     '#FF8A80', 
        //     //Pinks
        //     '#E91E63', 
        //     '#880E4F', 
        //     '#FF80AB', 
        //     //Purples
        //     '#9C27B0', 
        //     '#4A148C', 
        //     '#EA80FC', 
        //     //Deep Purple
        //     '#673AB7', 
        //     '#311B92', 
        //     '#B388FF', 
        //     //Indigo
        //     '#3F51B5', 
        //     '#1A237E', 
        //     '#8C9EFF',
        //     //Blue
        //     '#2196F3', 
        //     '#0D47A1', 
        //     '#82B1FF',
        //     //Light Blue
        //     '#03A9F4', 
        //     '#01579B', 
        //     '#80D8FF',
        //     //Cyan
        //     '#00BCD4', 
        //     '#006064', 
        //     '#84FFFF',
        //     //Teal
        //     '#009688', 
        //     '#004D40', 
        //     '#A7FFEB',
        //     //Green
        //     '#4CAF50', 
        //     '#1B5E20', 
        //     '#B9F6CA',
        //     //Light Green
        //     '#8BC34A', 
        //     '#33691E', 
        //     '#CCFF90',
        //     //Lime
        //     '#CDDC39', 
        //     '#827717', 
        //     '#F4FF81',
        //     //Yellow
        //     '#FFEB3B', 
        //     '#F57F17', 
        //     '#FFFF8D', 
        //     //Amber
        //     '#FFC107', 
        //     '#FF6F00', 
        //     '#FFE57F', 
        //     //Orange
        //     '#3F51B5', 
        //     '#1A237E', 
        //     '#8C9EFF', 
        //     //Deep Orange
        //     '#FF5722', 
        //     '#BF360C', 
        //     '#FF9E80', 
        //     //Brown
        //     '#795548', 
        //     '#3E2723', 
        //     '#BCAAA4', 
        //     //White
        //     '#FFFFFF' 
        //     ]


        var threads = [];


        var colors = [
        	'rgb(217, 82, 31)',
        	'rgb(143, 74, 45)',
        	'rgb(255, 108, 87)',
        	'rgb(255, 126, 138)',
        	'rgb(227, 190, 141)',
        	'rgb(255, 255, 255)',
        	'rgb(0, 0, 20)',

        ]


        var backingTrack = {

        }


       

        var themes = [
        	//Orange
	        {
	        	back:'rgb(217, 82, 31)',
	        	mid: 'rgb(143, 74, 45)',
	        	fore: 'rgb(255, 108, 87)',
	        	highlight: 'rgb(255, 126, 138)',
	        	accent: 'rgb(227, 190, 141)',
	        	light: 'rgb(255, 255, 255)',
	        	dark: 'rgb(0, 0, 20)'
	        },

	        //Purple
	        {
	        	back:'rgb(39, 6, 54)',
	        	mid: 'rgb(69, 26, 87)',
	        	fore: 'rgb(252, 25, 246)',
	        	highlight: 'rgb(52, 255, 253)',
	        	accent: 'rgb(133, 102, 193)',
	        	light: 'rgb(253, 228, 252)',
	        	dark: 'rgb(255, 255, 255)'
	        }
        ]







		


		console.log(width, height, center, two.renderer);




		


        




		var states = [
			{
				theme:themes[0],

				//Thread behaviour
				threadOpts:{
					//An array of shapes to draw
					shapes:[
				        {
				            color:themes[0].mid,
				            weight: 1,
				            yOffset:-100,
				            filled:true,
				        },

				        {
				            color:themes[0].fore,
				            weight: 3,
				            yOffset:0,
				            filled:true,
				        },

				        {
				            color:themes[0].light,
				            weight: 5,
				            yOffset:100,
				            filled:true,
				        }
				    ]
				},

				//Cuepoint Behaviour
				cuepointOpts:{
					onCreate:function(){
						//Must return a display object
						//This references cuepoint object
				        var circle = two.makeCircle(this.x, this.y, this.size);
				        circle.fill = state.theme.accent;
				        circle.noStroke();
				        circle.scale = 0.1;
				        return circle;
					},
					onTrigger:function(){
						//Animation for cuepoint trigger
						//This references cuepoint object

						//Cuepoint Animation
				        var triggerAnimation = new TWEEN.Tween(this.display)
				            .to({scale:2, opacity:0}, duration * 0.25)
				            .easing(Easing.Circular.Out)
				            .onComplete(function() {
				                this.scale = 0.1;
				                this.opacity = 1;
				            });

				        triggerAnimation.start();

				        //Secondary animations
				        this.thread.jitter();

				        //Trigger audio for cuepoint
				        var i = Math.floor((Math.min(this.size, 100)/100)*24);
				        samples[Object.keys(samples)[i]].play();
					},
					onDestroy:function(){

					}
				}
			},


			{
				theme:themes[1],

				//Thread behaviour
				threadOpts:{
					//An array of shapes to draw
					shapes:[
				        {
				            color:themes[1].mid,
				            weight: 1,
				            yOffset:0,
				            filled:false,
				        },

				        {
				            color:themes[1].fore,
				            weight: 3,
				            yOffset:0,
				            filled:false,
				        },

				        {
				            color:themes[1].light,
				            weight: 5,
				            yOffset:0,
				            filled:false,
				        }
				    ]
				},

				//Cuepoint Behaviour
				cuepointOpts:{
					onCreate:function(){
						//Must return a display object
						//This references cuepoint object
				        var circle = two.makeCircle(this.x, this.y, this.size);
				        circle.fill = state.theme.accent;
				        circle.noStroke();
				        circle.scale = 0.1;
				        return circle;
					},
					onTrigger:function(){
						//Animation for cuepoint trigger
						//This references cuepoint object

						//Cuepoint Animation
				        var triggerAnimation = new TWEEN.Tween(this.display)
				            .to({scale:2, opacity:0}, duration * 0.25)
				            .easing(Easing.Circular.Out)
				            .onComplete(function() {
				                this.scale = 0.1;
				                this.opacity = 1;
				            });

				        triggerAnimation.start();

				        //Secondary animations
				        this.thread.jitter();

				        //Trigger audio for cuepoint
				        var i = Math.floor((Math.min(this.size, 100)/100)*24);
				        samples[Object.keys(samples)[i]].play();
					},
					onDestroy:function(){

					}
				}
			},

		]


		var state = states[0];


		two.renderer.domElement.style.background = state.theme.back;











        
		function Player(id){
			this.id = id;
			this.thread = null;
			// this.threadOpts = state.threadOpts[0]
		}

		Player.prototype.dragStart = function(e){
			console.log('drag start')
			if(!this.thread){
				this.thread = new Thread(e.x, e.y);
				this.thread.shapeOpts = state.threadOpts.shapes;
				threads.push(this.thread);
			}else{


				console.log(this.thread.state)

				if(this.thread.state == 'recycled'){
					this.thread.lastPos = new Two.Anchor(0, e.y+10);
					this.thread.shapeOpts = state.threadOpts.shapes;
					this.thread.state = 'creating'
				}

			}
        }

        Player.prototype.drag = function(e){
        	if(this.thread.state == 'creating'){
        		var pos = new Two.Anchor(e.x, e.y);
            	this.thread.draw(pos);
        	}
        	
        }

        Player.prototype.dragEnd = function(e){
        	if(this.thread.state == 'creating'){
	        	var pos = new Two.Anchor(e.x, e.y);
	            this.thread.endDraw(pos);
	        }
        }





		var players = {};
		var threads = [];

        
		


		$(document).ready(function(){

			//bind sockets

			//connect to the server
			socket.emit('connectViewer');

			socket.on('connected', function(existingPlayers){
				existingPlayers.forEach(function(playerId){
					addPlayer(playerId);
				});

				console.log('viewer connected, existing players', players, existingPlayers);
			});

			//add player when they connect
			socket.on('addPlayer', function(playerId){
				addPlayer(playerId);
			});

			//recieve player input
			socket.on('playerUpdate', function(input){

				// console.log('update', input)

				if(input.type == 'start'){
					players[input.id].dragStart(input);
				}else if(input.type == 'drag'){
					players[input.id].drag(input);
				}else if(input.type == 'end'){
					players[input.id].dragEnd(input);
				}
			});



			//Listen for tick
			socket.on('tick', function(beatCount){
				if(beatCount == 0){
					console.log('new bar', animations);

					setState(states[Math.floor(Math.random()*states.length)])
				}


				//16th note here

				threads.forEach(function(thread){
					thread.triggerCuePoints(beatCount)
				});
			});







			two.bind('update', function(frameCount) {
				//Update animateables
                TWEEN.update();
	           
                threads.forEach(function(thread){
                	thread.update();
                });
		

	      	}).play();
		});


		function addPlayer(playerId){
			var player = new Player(playerId);
			players[playerId] = player;

			console.log('players', players)
		}






		function setState(newState){

			state = newState;
			//update background color
			animations['horizontalWipe'].start(state.theme.back);


			//update 
		}




	 //    function makeNgon(w, h, s){
	 //    	var shape = this.makePolygon(
		// 		_.map(_.range(s), function(i) {
		// 			var percent = i / s;
		// 			var theta = TWO_PI * percent - Math.PI / 2;
		// 			var x = w * Math.cos(theta);
		// 			var y = h * Math.sin(theta);
		// 			return new Two.Anchor(x, y);
		// 		})
		// 	);

		// 	return shape
	 //    }




	</script>

	<script src="CuePoint.js"></script>
    <script src="threads-alt.js"></script>
    <script src="metronome.js"></script>
    <script src="animations.js"></script>
    <script src="audio.js"></script>
	</body>
</html>